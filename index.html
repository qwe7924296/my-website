<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner with Vue 3</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@next"></script>
    <!-- ZXing Library for QR Code scanning -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
    <div id="app">
        <div style="float: left; width: 50%;">
            <video id="reader" style="width: 300px; height: 300px;" autoplay playsinline></video>
        </div>
        <div style="float: right; width: 50%;">
            <button @click="scanQRCode">Scan QR Code</button>
            <div v-if="qrResult">QR Code Result: {{ qrResult }}</div>
        </div>
    </div>

    <script>
        const { ref } = Vue;

        const app = Vue.createApp({
            data() {
                return {
                    qrResult: null,
                    codeReader: new ZXing.BrowserMultiFormatReader()
                };
            },
            methods: {
                async scanQRCode() {
                    try {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const rearCamera = devices.find(device => device.kind === 'videoinput' && /back|rear/i.test(device.label));
                        const cameraId = rearCamera ? rearCamera.deviceId : undefined;

                        this.codeReader.decodeFromVideoDevice(cameraId, 'reader', (result, err) => {
                            if (result) {
                                this.qrResult = result.text;
                                this.codeReader.reset();

                                const numberMatch = this.qrResult.match(/\d+/);
                                if (numberMatch) {
                                    const no = numberMatch[0];
                                    this.sendToBackend(no);
                                }
                            }
                        });
                    } catch (error) {
                        console.error("Error initializing camera", error);
                    }
                },
                sendToBackend(no) {
                    fetch("https://69bc-114-47-218-48.ngrok-free.app/search", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ no: no })
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert("Backend response: " + JSON.stringify(data)); // 使用 alert 來顯示後端的響應
                    })
                    .catch(error => {
                        console.error("Error sending data to backend:", error);
                    });
                }
            }
        });

        app.mount("#app");
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner with Vue 3</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@next"></script>
    <!-- ZXing Library for QR Code scanning -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <!-- Bootstrap for styling -->
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-light">
    <div class="container mt-5">
      <div id="app" class="text-center">
        <div class="mb-4">
          <video
            id="reader"
            style="width: 300px; height: 300px"
            autoplay
            playsinline
          ></video>
        </div>
        <hr />
        <button class="btn btn-primary" @click="scanQRCode">
          Scan QR Code
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const app = Vue.createApp({
          data() {
            return {
              codeReader: new ZXing.BrowserMultiFormatReader(),
              isScanning: false,
            };
          },
          methods: {
            async scanQRCode() {
              if (this.isScanning) {
                console.log("Already scanning...");
                return;
              }

              this.isScanning = true;

              try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const rearCamera = devices.find(
                  (device) =>
                    device.kind === "videoinput" &&
                    /back|rear/i.test(device.label)
                );
                const cameraId = rearCamera ? rearCamera.deviceId : undefined;

                this.codeReader.decodeFromVideoDevice(
                  cameraId,
                  "reader",
                  (result, err) => {
                    if (result) {
                      const content = result.text;
                      if (/^\d+$/.test(content)) {
                        // 如果是數字，則透過API POST到指定的後端網址
                        this.sendToBackend(content);
                      } else {
                        alert("不是數字，內容是：" + content);
                      }
                      this.codeReader.reset();
                      this.isScanning = false;
                    }
                  }
                );
              } catch (error) {
                console.error("Error initializing camera", error);
                this.isScanning = false;
              }
            },

            sendToBackend(no) {
              var xhr = new XMLHttpRequest();
              xhr.open(
                "POST",
                "https://ac44-114-47-202-96.ngrok-free.app/search",
                true
              );
              xhr.setRequestHeader(
                "Content-Type",
                "application/json;charset=UTF-8"
              );

              xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                  if (xhr.status == 200) {
                    alert("Received data from backend: " + xhr.responseText);
                  } else {
                    alert(
                      "Error sending data to backend: " +
                        xhr.status +
                        " - " +
                        xhr.statusText
                    );
                  }
                }
              };

              xhr.send(JSON.stringify({ no: no }));
            },
          },
        });
        app.mount("#app");
      });
    </script>
  </body>
</html>

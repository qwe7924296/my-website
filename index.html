<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Scanner with Vue 3</title>
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@next"></script>
    <!-- ZXing Library for QR Code scanning -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap 5 JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
    />
    <!-- DataTables JS -->
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"
    ></script>

    <!-- CSS -->
    <style>
      body {
        font-family: "Avenir", Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background: linear-gradient(45deg, #f3f4f6, #fff);
      }

      .container {
        max-width: 960px;
        margin: 5% auto;
        border-radius: 20px;
        box-shadow: 0px 0px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
        background: #fff;
      }

      button {
        border: none;
        background-color: #007bff;
        padding: 10px 20px;
        color: #fff;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #0056b3;
      }

      video {
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      hr {
        border: 0;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body>
    <div class="container mt-5">
      <div id="app" class="text-center">
        <div class="mb-4">
          <video
            id="reader"
            style="width: 300px; height: 300px"
            autoplay
            playsinline
          ></video>
        </div>
        <hr />
        <button class="btn btn-primary" @click="scanQRCode">
          Scan QR Code
        </button>
        <table class="mt-4 table" id="dataTable"></table>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const app = Vue.createApp({
          data() {
            return {
              codeReader: new ZXing.BrowserMultiFormatReader(),
              isScanning: false,
              tableHeaders: [], // 新增的屬性
              tableData: [], // 新增的屬性
            };
          },
          mounted() {
            // 在頁面加載時自動發送請求
            this.sendToBackend("144");
          },
          methods: {
            async scanQRCode() {
              if (this.isScanning) {
                console.log("Already scanning...");
                return;
              }

              this.isScanning = true;

              try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const rearCamera = devices.find(
                  (device) =>
                    device.kind === "videoinput" &&
                    /back|rear/i.test(device.label)
                );
                const cameraId = rearCamera ? rearCamera.deviceId : undefined;

                this.codeReader.decodeFromVideoDevice(
                  cameraId,
                  "reader",
                  (result, err) => {
                    if (result) {
                      const content = result.text;
                      if (/^\d+$/.test(content)) {
                        // 如果是數字，則透過API POST到指定的後端網址
                        this.sendToBackend(content);
                      } else {
                        alert("不是數字，內容是：" + content);
                      }
                      this.codeReader.reset();
                      this.isScanning = false;
                    }
                  }
                );
              } catch (error) {
                console.error("Error initializing camera", error);
                this.isScanning = false;
              }
            },

            sendToBackend(no) {
              var xhr = new XMLHttpRequest();
              xhr.open(
                "POST",
                "https://8281-210-61-64-165.ngrok-free.app/qr-code-items",
                true
              );
              xhr.setRequestHeader(
                "Content-Type",
                "application/json;charset=UTF-8"
              );

              xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                  if (xhr.status == 200) {
                    alert("Received data from backend: " + xhr.responseText);
                    this.tableData = JSON.parse(xhr.responseText);
                    // 更新DataTables
                    if ($.fn.dataTable.isDataTable("#dataTable")) {
                      $("#dataTable").DataTable().destroy();
                    }
                    $("#dataTable").DataTable({
                      data: this.tableData,
                      columns: Object.keys(this.tableData[0]).map((key) => ({
                        title: key,
                        data: key,
                      })),
                    });
                  } else {
                    // 失敗
                    alert(
                      "Error sending data to backend: " +
                        xhr.status +
                        " - " +
                        xhr.statusText
                    );
                  }
                }
              }.bind(this); // 注意綁定this

              xhr.send(JSON.stringify({ no: no }));
            },
          },
        });
        app.mount("#app");
      });
    </script>
  </body>
</html>
